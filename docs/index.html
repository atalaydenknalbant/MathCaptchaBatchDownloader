<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Bulk Math Captchas Downloader</title>
  <style>
    body   { font-family: sans-serif; padding: 20px; }
    .grid  { display: grid;
              grid-template-columns: repeat(5, auto);
              gap: 8px;
              margin: 16px 0; }
    img    { border: 1px solid #ccc; }
    label  { font-weight: bold; margin-right: 8px; }
    input  { width: 80px; padding: 4px; }
    button { padding: 8px 16px; margin-left: 12px; }
    #status { margin-top: 12px; color: #3a7; }
  </style>
</head>
<body>

  <h1>15 Math-captchas</h1>

  <div>
    <label for="count"># of ZIPs:</label>
    <input type="number" id="count" value="100" min="1" step="1">
    <button id="dl">Start Download</button>
  </div>

  <p id="status">Ready</p>

  <div id="grid" class="grid"></div>

  <!-- JSZip & FileSaver via CDN -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/FileSaver.js/2.0.5/FileSaver.min.js"></script>

  <script>
    const grid   = document.getElementById('grid');
    const status = document.getElementById('status');
    const btn    = document.getElementById('dl');
    const inp    = document.getElementById('count');

    // Render N=15 captcha <img> tags on page load or reload
    function renderCaptchas() {
      grid.innerHTML = '';
      for (let i = 0; i < 15; i++) {
        const img = document.createElement('img');
        img.src = `/DefaultCaptcha/Generate?t=${crypto.randomUUID()}`;
        img.setAttribute('alt', 'captcha');
        grid.appendChild(img);
      }
    }

    // Wait until every <img> in #grid is fully loaded
    function waitAll() {
      return Promise.all(
        Array.from(grid.querySelectorAll('img')).map(img =>
          img.complete 
            ? Promise.resolve()
            : new Promise(r => img.onload = r)
        )
      );
    }

    // Capture 15 images into a ZIP blob
    async function makeZipBlob() {
      await waitAll();
      const zip = new JSZip();
      for (const img of grid.querySelectorAll('img')) {
        // draw image into canvas
        const cvs = document.createElement('canvas');
        cvs.width  = img.naturalWidth;
        cvs.height = img.naturalHeight;
        cvs.getContext('2d').drawImage(img, 0, 0);
        // canvas â†’ PNG blob
        const blob = await new Promise(r => cvs.toBlob(r, 'image/png'));
        // extract the t= token for filename
        const url   = new URL(img.src, location.origin);
        const token = url.searchParams.get('t') || crypto.randomUUID().replace(/-/g,'').slice(0,10);
        zip.file(`unknown_${token}.png`, blob);
      }
      status.textContent = 'Packing ZIPâ€¦';
      return zip.generateAsync({ type: 'blob' });
    }

    // One cycle: make ZIP, download, decrement counter, reload or finish
    async function runCycle() {
      let left    = +localStorage.getItem('todo') || 0;
      const total = +localStorage.getItem('initial') || 0;
      if (left <= 0) {
        status.textContent = 'All done ðŸŽ‰';
        btn.disabled = false;
        localStorage.removeItem('todo');
        localStorage.removeItem('initial');
        return;
      }

      status.textContent = `Batch ${total - left + 1} of ${total}`;
      const blobZip = await makeZipBlob();
      // download via hidden <a>
      const blobUrl = URL.createObjectURL(blobZip);
      const a       = document.createElement('a');
      a.style.display = 'none';
      a.href          = blobUrl;
      a.download      = `captchas_${Date.now()}.zip`;
      document.body.appendChild(a);
      a.click();
      document.body.removeChild(a);
      URL.revokeObjectURL(blobUrl);

      left--;
      localStorage.setItem('todo', left);
      // reload after a brief pause to allow the save dialog
      setTimeout(() => location.reload(), 600);
    }

    // Button sets up counters and kicks off first cycle
    btn.addEventListener('click', () => {
      const total = parseInt(inp.value, 10);
      if (!total || total < 1) {
        alert('Enter a positive number');
        return;
      }
      btn.disabled = true;
      localStorage.setItem('initial', total);
      localStorage.setItem('todo', total);
      renderCaptchas();
      runCycle();    // first cycle under user click
    });

    // On page load, if counter remains, continue
    window.addEventListener('DOMContentLoaded', () => {
      renderCaptchas();
      const left = +localStorage.getItem('todo') || 0;
      if (left > 0) {
        btn.disabled = true;
        runCycle();
      }
    });
  </script>
</body>
</html>
